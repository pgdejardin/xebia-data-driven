service:
  name: xdd-directory-extract

custom:
  stage: ${opt:stage, self:provider.stage}
  secrets: ${file(serverless-secrets.yml):${self:custom.stage}}

provider:
  name: aws
  runtime: java8
  region: eu-west-1
  iamRoleStatements:
    - Effect: "Allow"
      Action:
        - "s3:*"
      Resource:
        - "arn:aws:s3:::${self:custom.secrets.STORE_BUCKET}"
        - "arn:aws:s3:::${self:custom.secrets.STORE_BUCKET}/*"
        - "arn:aws:s3:::${self:custom.secrets.CREDENTIAL_BUCKET}"
        - "arn:aws:s3:::${self:custom.secrets.CREDENTIAL_BUCKET}/*"
    - Effect: "Allow"
      Action:
        - "kms:Encrypt"
        - "kms:Decrypt"
        - "kms:ReEncrypt*"
        - "kms:GenerateDataKey*"
        - "kms:DescribeKey"
      Resource:
        - "${self:custom.secrets.CREDENTIAL_KMS_KEY_ARN}"

package:
  artifact: build/distributions/directory-extract.zip

functions:
  directory-extract:
    handler: fr.xebia.api.directory.users.lambda.LambdaUsersExtract
    timeout: 60
    events:
      - schedule: cron(0 8 * * ? *)
    environment:
      DOMAIN: ${self:custom.secrets.DOMAIN}
      CREDENTIAL_BUCKET: ${self:custom.secrets.CREDENTIAL_BUCKET}
      CREDENTIAL_KEY: ${self:custom.secrets.CREDENTIAL_KEY}
      SERVICE_ACCOUNT_ID: ${self:custom.secrets.SERVICE_ACCOUNT_ID}
      SERVICE_ACCOUNT_USER: ${self:custom.secrets.SERVICE_ACCOUNT_USER}
      SERVICE_ACCOUNT_KEY_ALIAS: ${self:custom.secrets.SERVICE_ACCOUNT_KEY_ALIAS}
      SERVICE_ACCOUNT_KEY_PASSWORD: ${self:custom.secrets.SERVICE_ACCOUNT_KEY_PASSWORD}
      MAX_RESULTS: "200"
      STORE_BUCKET: ${self:custom.secrets.STORE_BUCKET}
      STORE_KEY: ${self:custom.secrets.STORE_KEY}
